# Phase T1: Mapping Procedures

Detailed procedures for the Mapping phase (task-builder, phase 1).

---

## Mission

Extract information from design artifacts (spec.md, plan.md, data-model.md, contracts/, research.md) and map all components to user stories. Output: `task-mapping.md` with complete story-to-component mappings and brownfield analysis.

---

## Story Extraction

### Source: spec.md

Extract all user stories with:
- Story ID (US1, US2, US3...)
- Priority (P1, P2, P3)
- Title/description
- Acceptance criteria
- Related functional requirements (FR-xxx)

### Organize by Priority

```markdown
## User Stories

### US1: [P1] User can set task priority
- **Acceptance Criteria**: ...
- **Requirements**: FR-001, FR-002

### US2: [P2] User can filter by priority
- **Acceptance Criteria**: ...
- **Requirements**: FR-003
```

---

## Entity Mapping

### Source: data-model.md (if exists)

For each entity:
1. Identify which user story(ies) need this entity
2. Record the mapping: Entity -> Story
3. Note if entity is:
   - **New** - Needs creation
   - **Shared** - Serves multiple stories (put in earliest story or Setup phase)

### Mapping Format

```markdown
### US1: [P1] User can set task priority

**Mapped Entities**:
- Task (extends existing)
- Priority (new enum)
```

### Fallback: Infer from spec.md

If no data-model.md exists, infer entities from:
- Nouns in user stories
- Functional requirements
- Acceptance criteria

---

## Endpoint Mapping

### Source: contracts/ (if exists)

For each endpoint:
1. Identify which user story this endpoint serves
2. Record the mapping: Endpoint -> Story
3. Note HTTP method and path

### Mapping Format

```markdown
### US1: [P1] User can set task priority

**Mapped Endpoints**:
- POST /api/tasks (create with priority)
- PUT /api/tasks/{id} (update priority)
```

### Fallback: Infer from spec.md

If no contracts/ exists, infer endpoints from:
- User actions in stories
- CRUD operations implied
- Acceptance criteria requirements

---

## Brownfield Analysis

*See [BROWNFIELD.md](BROWNFIELD.md) for detailed procedures.*

If brownfield inventory exists:

1. Read `codebase-inventory.json`
2. For each mapped entity:
   - Check if exists in inventory
   - Classify risk level
   - Record existing file path
3. For each mapped endpoint:
   - Check if route exists in inventory
   - Classify risk level
   - Record existing file path
4. Flag high-risk collisions for escalation

---

## Gap Detection

Check for mapping completeness:

| Gap Type | Description | Action |
|----------|-------------|--------|
| Orphaned entities | Entities not mapped to any story | Flag for review |
| Orphaned endpoints | Endpoints not mapped to any story | Flag for review |
| Uncovered stories | Stories with no entities/endpoints mapped | Infer or flag |
| Missing brownfield | Existing items not analyzed | Complete analysis |

---

## task-mapping.md Format

```markdown
# Task Mapping: {feature_id}

> Generated by task-builder agent (phase 1)
> Iteration: {iteration}
> Timestamp: {timestamp}

---

## Summary

| Metric | Count |
|--------|-------|
| User Stories | {story_count} |
| Entities Mapped | {entity_count} |
| Endpoints Mapped | {endpoint_count} |
| Brownfield Risks | {risk_count} |

---

## User Stories

### US1: [P1] {Story title}

**Acceptance Criteria**:
{from spec.md}

**Mapped Components**:
- **Entities**: {entity_list}
- **Endpoints**: {endpoint_list}
- **Setup Decisions**: {from research.md if applicable}

**Brownfield Notes**: {existing items, recommended actions}

---

### US2: [P2] {Story title}

[Same structure...]

---

## Brownfield Analysis

### Existing Entities

| Entity | File Path | Risk Level | Recommended Action |
|--------|-----------|------------|-------------------|
| {entity} | {path} | {Low/Medium/High} | {EXTEND/MODIFY/CONFLICT} |

### Existing Endpoints

| Endpoint | File Path | Risk Level | Recommended Action |
|----------|-----------|------------|-------------------|
| {method} {path} | {file} | {risk} | {action} |

### High-Risk Collisions

| Item | Conflict | Resolution Required |
|------|----------|---------------------|
| {item} | {conflict_description} | User decision needed |

---

## Unmapped Items

### Orphaned Entities
{list or "(none)"}

### Orphaned Endpoints
{list or "(none)"}

---

## Mapping Validation

| Check | Status |
|-------|--------|
| All P1/P2 stories mapped | {Pass/Fail} |
| All entities mapped | {Pass/Fail} |
| All endpoints mapped | {Pass/Fail} |
| Brownfield analyzed | {Pass/Fail} |
```

---

## Quality Checklist

Before returning, verify:
- [ ] All user stories from spec.md are extracted with priorities
- [ ] All entities from data-model.md are mapped to stories
- [ ] All endpoints from contracts/ are mapped to stories
- [ ] Brownfield analysis is complete (if inventory exists)
- [ ] High-risk collisions are flagged for escalation
- [ ] No orphaned items (or explicitly documented)
- [ ] task-mapping.md is complete and well-structured
- [ ] tasks-context.md Phase T1 section is updated
- [ ] index.md Tasks Phase State is updated
